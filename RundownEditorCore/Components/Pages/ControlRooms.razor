@page "/controlrooms"

@inject IControlRoomService ControlRoomService
@inject IHardwareService HardwareService

@attribute [Authorize(Roles = "Administrator")]
<PageTitle>Kontrolrum</PageTitle>
<div class="container-fluid" style="max-width:1600px">
    <h3>Kontrolrum og Hardware</h3>
    <div class="row mt-2">
        <div class="col-xl-4">

            <CreateControlRoomForm ControlRoom="newControlRoom" OnValidSubmit="CreateControlRoomAsync" />


            @if (editingControlRoom != null)
            {
                <EditControlRoomForm ControlRoom="editingControlRoom"
                                     OnDelete="DeleteControlRoom"
                                     OnValidSubmit="UpdateControlRoomAsync"
                                     OnCancel="CancelEdit" />

            }

            @if (addingHardwareToRoom != null)
            {
                <AddHardwareToControlRoomForm Hardware="newHardware"
                                              Room="@addingHardwareToRoom"
                                              OnValidSubmit="CreateHardwareAsync"
                                              OnCancel="CancelEdit" />

            }

            @if (editingHardware != null)
            {
                <EditHardwareForm Hardware="editingHardware"
                                  OnDelete="DeleteHardware"
                                  OnValidSubmit="UpdateHardwareAsync"
                                  OnCancel="CancelEdit" />

            }

        </div>
        <div class="col-xl-8">
            <div class="card mb-2">
                <div class="card-body">

                    <h5 class="card-title">Kontrolrum og Hardware</h5>
                    @if (controlRooms == null)
                    {
                        <p><em>Indlæser kontrolrum...</em></p>
                    }
                    else
                    {
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Navn</th>
                                    <th>Lokation</th>
                                    <th>Hardware</th>
                                    <th>Oprettet</th>
                                    <th>Handlinger</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var room in controlRooms.OrderBy(r => r.Name))
                                {
                                    <tr>
                                        <td>@room.Name</td>
                                        <td>@room.Location</td>
                                        <td>
                                            <ul>
                                                @foreach (var hardware in room.HardwareItems)
                                                {
                                                    <li><a role="button" class="link-dark" @onclick="() => EditHardware(hardware.Uuid)">@hardware.Name (@hardware.Model)</a></li>
                                                }
                                            </ul>
                                        </td>
                                        <td>@room.CreatedDate.ToLocalTime().ToShortDateString()</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" @onclick="() => EditControlRoom(room.Uuid.ToString())">Rediger</button>
                                            <button class="btn btn-sm btn-primary" @onclick="() => AddHardware(room.Uuid.ToString())">Tilføj Hardware</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>


        </div>
    </div>
</div>

@code {
    private List<ControlRoomDTO> controlRooms;
    private ControlRoomDTO newControlRoom = new ControlRoomDTO();
    private ControlRoomDTO editingControlRoom;
    private ControlRoomDTO addingHardwareToRoom;
    private HardwareDTO newHardware = new HardwareDTO();
    private HardwareDTO editingHardware;

    protected override async Task OnInitializedAsync()
    {
        controlRooms = await ControlRoomService.GetControlRoomsAsync();
    }
    /// <summary>
    /// Nulstiller og lukker alle åbne forms
    /// </summary>
    private void CancelEdit()
    {
        editingControlRoom = null;
        addingHardwareToRoom = null;
        editingHardware = null;
    }

    private async Task CreateControlRoomAsync()
    {   
        await ControlRoomService.CreateControlRoomAsync(newControlRoom);
        controlRooms = await ControlRoomService.GetControlRoomsAsync(); 
        newControlRoom = new ControlRoomDTO(); 
    }
    /// <summary>
    /// Lukker åbne forms og viser redigeringsform for det valgte kontrolrum
    /// </summary>
    /// <param name="id"></param>
    private void EditControlRoom(string id)
    {
        CancelEdit();
        editingControlRoom = controlRooms.FirstOrDefault(room => room.Uuid.ToString() == id);
    }

    private async Task UpdateControlRoomAsync()
    {
        await ControlRoomService.UpdateControlRoomAsync(editingControlRoom.Uuid.ToString(), editingControlRoom);
        controlRooms = await ControlRoomService.GetControlRoomsAsync(); 
        editingControlRoom = null; 
    }    

    private async Task DeleteControlRoom(string id)
    {
        await ControlRoomService.DeleteControlRoomAsync(id);
        controlRooms = await ControlRoomService.GetControlRoomsAsync(); 
        editingControlRoom = null;
    }
    /// <summary>
    /// Lukker åbne forms og viser form til at tilføje hardware til et kontrolrum
    /// </summary>
    /// <param name="controlRoomId"></param>
    private void AddHardware(string controlRoomId)
    {
        CancelEdit();
        addingHardwareToRoom = controlRooms.FirstOrDefault(room => room.Uuid.ToString() == controlRoomId);
        newHardware = new HardwareDTO { ControlRoomId = controlRoomId };
    }
    /// <summary>
    /// Lukker åbne forms og viser form til at redigere hardware
    /// </summary>
    /// <param name="id"></param>
    private void EditHardware(string id)
    {
        CancelEdit();
        editingHardware = controlRooms.SelectMany(room => room.HardwareItems).FirstOrDefault(hardware => hardware.Uuid == id);
    }

    private async Task CreateHardwareAsync()
    {
        await HardwareService.AddHardwareAsync(newHardware);
        controlRooms = await ControlRoomService.GetControlRoomsAsync(); 
        newHardware = new HardwareDTO(); 
        addingHardwareToRoom = null;
    }

    private async Task UpdateHardwareAsync()
    {
        await HardwareService.UpdateHardwareAsync(editingHardware.Uuid, editingHardware);
        controlRooms = await ControlRoomService.GetControlRoomsAsync(); 
        editingHardware = null; 
    }

    private async Task DeleteHardware(string id)
    {
        await HardwareService.DeleteHardwareAsync(id);
        controlRooms = await ControlRoomService.GetControlRoomsAsync();
        editingHardware = null; 
    }
}
